@startuml
title test_arch Project - Full UML Class Diagram

skinparam classAttributeIconSize 0
skinparam ArrowColor #3C3C3C
skinparam ClassBorderColor #333
skinparam ClassBackgroundColor #EEE
skinparam RectangleBackgroundColor #F8F8F8
skinparam Shadowing false


' ==========================
' DATA LAYER
' ==========================

package "data (Data Layer)"<<Database>> {

class DataLoader {
    + load_csv()
    + parse_basic_info()
    + parse_category_info()
    + parse_dimension_info()
}
DataLoader --> ConfigLoader : dependency
}

' ==========================
' CONFIG LAYER
' ==========================

package "configs (Configuration Layer)" {

class ConfigManager {
    - rules_dir: Path
    + load_all_rules()
    + load_toml()
}

class ConfigLoader {
    + load_structure(name)
    + load_roof_types()
    + load_grades()
}

class BaseConfigToml <<TomlFile>>
class RoofTypesToml <<TomlFile>>
class ConstructionGradesToml <<TomlFile>>
class BuildingFormsToml <<TomlFile>>
class StructuralModulesToml <<TomlFile>>

class ClassMappingJson <<JsonFile>>

ConfigLoader --> ConfigManager : dependency
ClassMappingJson --> ConfigLoader : association
}


' ==========================
' CORE LAYER (LOGIC)
' ==========================

package "core (Logic Layer)" {

class FormInferencer {
    + infer_structure()
    + infer_num_purlins()
    + infer_category()
}

FormInferencer --> DataLoader : dependency
FormInferencer --> ConfigLoader : dependency

class CalculatorFactory {
    + register(type, class)
    + get_calculator(type)
}

CalculatorFactory --> ClassMappingJson : association


' ---- calculators ----

class BaseCalculator <<abstract>> {
    + compute_pillars()
    + compute_beams()
    + compute_roof()
}

class HouseCalculator {
    + compute_pillars()
    + compute_beams()
    + compute_roof()
}

class PavilionCalculator {
    + compute_pillars()
    + compute_beams()
    + compute_roof()
}

BaseCalculator <|-- HouseCalculator : generalization
BaseCalculator <|-- PavilionCalculator : generalization

CalculatorFactory --> BaseCalculator : dependency
}


' ==========================
' STRUCTURE LAYER (MODELING)
' ==========================

package "structure (Modeling Layer)" {

package "components" {
class ComponentPillar {
    + create_mesh()
}
class ComponentBeam {
    + create_mesh()
}
class ComponentRoof {
    + create_mesh()
}
}

package "frame" {

class PillarFrame {
    - coords[]
    + build_pillars()
}
class BeamFrame {
    - coords[]
    + build_beams()
}
class RoofSystem {
    + build_roof()
}

' Composition (components belong to frame)
PillarFrame *-- ComponentPillar : composition
BeamFrame *-- ComponentBeam : composition
RoofSystem *-- ComponentRoof : composition
}

class Assembler {
    + assemble_all()
    + link_to_scene()
}

' Aggregation (assembler aggregates frames)
Assembler o-- PillarFrame : aggregation
Assembler o-- BeamFrame : aggregation
Assembler o-- RoofSystem : aggregation

class MeshPool {
    + get_or_create_mesh()
}

Assembler --> MeshPool : dependency
}


' ==========================
' APPLICATION LAYER
' ==========================

package "Application Layer" {

class Generator {
    + run()
}

class Main <<entrypoint>>

Main --> Generator : dependency

Generator --> DataLoader : dependency
Generator --> FormInferencer : dependency
Generator --> CalculatorFactory : dependency
Generator --> Assembler : dependency
}


@enduml
